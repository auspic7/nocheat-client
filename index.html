<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>

<body>
    <a id="download">Download</a>
    <button id="stop">Stop</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.dev.js"></script>
    <script>
        let shouldStop = false;
        let stopped = false;
        var recordedChunks = [];
        const downloadLink = document.getElementById('download');
        const stopButton = document.getElementById('stop');

        stopButton.addEventListener('click', function () {
            console.log("stop");
            shouldStop = true;
        })

        // var socket = io("http://localhost:5000/");
        // socket.on('connect', function () {
        //     socket.emit('message', {
        //         data: "blabla"
        //     });
        // });

        navigator.mediaDevices.getUserMedia({
                audio: true,
                video: false
            })
            .then(stream => {
                const recorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                })
                recorder.ondataavailable = function (e) {
                    console.log(e.data)
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }

                    if (shouldStop === true && stopped === false) {
                        recorder.stop();
                        stopped = true;
                    }
                }
                recorder.onstop = function (e) {
                    downloadLink.href = URL.createObjectURL(new Blob(recordedChunks));
                    downloadLink.download = 'acetest.wav';
                }

                recorder.start(500);
                setInterval(() => {
                    console.log(recorder)
                }, 1000);
            })
    </script>
</body>

</html>